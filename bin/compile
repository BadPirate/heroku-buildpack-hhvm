#!/bin/bash

set -e
shopt -s dotglob

basedir="$( cd -P "$( dirname "$0" )" && pwd )"

function fetch_package() {
    local engine="$1"
    local version="$2"
    local location="$3"

    mkdir -p "$location"

    local package="http://dl.hhvm.com/heroku/hhvm.tgz"

    curl "$package" -L -s -o - | tar xzf - -C "$location"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
        Darwin) sed -l "$c";;
        *)      sed -u "$c";;
    esac
}

function mktmpdir() {
    dir=$(mktemp -t php-$1-XXXX)
    rm -rf $dir
    mkdir -p $dir
    echo $dir
}

BUILD_DIR="$1"
CACHE_DIR="$2"

cd "$BUILD_DIR"

HHVM_VERSION="2.1.0"

echo "-----> Vendoring HHVM ${HHVM_VERSION}"

if [ -d "$CACHE_DIR/hhvm" ]; then
  echo "-----> $CACHE_DIR/hhvm exists, not downloading";
else
  echo "-----> Downloading HHVM"
  [ ! -d "CACHE_DIR" ] && mkdir -p "$CACHE_DIR"
  mkdir "$CACHE_DIR/hhvm"
  fetch_package hhvm "$HHVM_VERSION" "$CACHE_DIR/hhvm"
fi

echo "-----> Vendoring binaries into slug"

[ ! -d "$BUILD_DIR/vendor" ] && mkdir -p "$BUILD_DIR/vendor"

cp -R "$CACHE_DIR/hhvm/" "vendor/hhvm"

cp "$basedir/../conf/config.hdf" "vendor/hhvm"

# Test that all packages were fetched and extracted successfully
test -d "vendor/hhvm"

if [ -n "$BUILDPACK_DEBUG" ]; then
    ls -R vendor/hhvm
fi
